define('ds2-tracking-video-layer',
    ['jquery',
     'ds2-tracking-base',
     'ds2-tracking'],
    function ($, ds2TrackingBase, tracking) {
        $.widget('digitals2.ds2TrackingVideoLayer', ds2TrackingBase, {

            _listenersInit: function () {
                var self = this;

                $('.ds2-video-player', this.element)
                    .on('ds2-video-player-play-layer', function (event, trackObj) {
                        self._callExpandEvent(trackObj,
                            self.bmwTrackOptionsBuilder.options()
                                .name(self.TC.START_VIDEO)
                                .build());
                    })
                    .on('ds2-video-player-track-absolute-progress', function (event, eventObj) {
                        eventObj.eventAction = 'Progress';
                        self._trackVideoEvent(this, eventObj);
                    })
                    .on('ds2-video-player-track-relative-progress', function (event, eventObj) {
                        eventObj.eventAction = 'Milestone';
                        self._trackVideoEvent(this, eventObj);
                    });

                this._super();
            },

            _trackVideoEvent: function (scope, eventObj) {
                var self = this,
                    $element = $(scope),
                    pMappedEvent,
                    pMappedObj = {},
                    eventName;

                eventName = $element.data('tracking-options').name;

                if ($element.data('tracking-options') && $element.data('tracking-options').name) {
                    // special pMappedEvent for milestone and progress events
                    if (eventObj.eventAction === 'Progress') {
                        pMappedEvent = self._loopProp(self.options.mappingObj, 'record_video_progress_seconds');
                    } else if (eventObj.eventAction === 'Milestone') {
                        pMappedEvent = self._loopProp(self.options.mappingObj, 'record_video_progress_percent');
                    } else {
                        pMappedEvent = self._loopProp(self.options.mappingObj, eventName);
                    }
                    pMappedObj = self._mapFilter(pMappedEvent, $element.data('tracking-options').content);
                }

                self._callExpandEvent(
                    self.eventBuilder.newEvent()
                        .eventName(eventName)
                        .eventAction(eventObj.eventAction)
                        .target(eventObj.target)
                        .effect(eventObj.milestone)
                        .primaryCategoryIsEngagement()
                        .videoLength(eventObj.duration)
                        .build(),
                    pMappedObj
                );
            }
        });

        return function($layerVideo) {
            $layerVideo.ds2TrackingVideoLayer(tracking.getOptions('ds2-layer-video'));
        }
    }
);

define('ds2-tracking-video-container',
    ['jquery',
     'ds2-tracking-base',
     'ds2-tracking'],
    function ($, ds2TrackingBase, tracking) {
        $.widget('digitals2.ds2TrackingVideoContainer', ds2TrackingBase, {

            _listenersInit: function () {
                var self = this;

			$('.ds2-video-player:not(.ds2-lightbox *)', this.element)
				.on('ds2-video-player-play', function (event, trackObj) {
					self._callExpandEvent(trackObj,
						self.bmwTrackOptionsBuilder.options()
							.name(self.TC.START_VIDEO)
							.build());
				})
				.on('ds2-video-player-track-absolute-progress', function (event, eventObj) {
					eventObj.eventAction = 'Progress';
					self._trackVideoEvent(this, eventObj);
				})
				.on('ds2-video-player-track-relative-progress', function (event, eventObj) {
					eventObj.eventAction = 'Milestone';
					self._trackVideoEvent(this, eventObj);
				});

                this._super();
            },

            _trackVideoEvent: function (scope, eventObj) {
                var self = this,
                    $element = $(scope),
                    pMappedEvent,
                    pMappedObj = {},
                    eventName;

                eventName = $element.data('tracking-options').name;

                if ($element.data('tracking-options') && $element.data('tracking-options').name) {
                    // special pMappedEvent for milestone and progress events
                    if (eventObj.eventAction === 'Progress') {
                        pMappedEvent = self._loopProp(self.options.mappingObj, 'record_video_progress_seconds');
                    } else if (eventObj.eventAction === 'Milestone') {
                        pMappedEvent = self._loopProp(self.options.mappingObj, 'record_video_progress_percent');
                    } else {
                        pMappedEvent = self._loopProp(self.options.mappingObj, eventName);
                    }

                    pMappedObj = self._mapFilter(pMappedEvent, $element.data('tracking-options').content);
                }


                self._callExpandEvent(
                    self.eventBuilder.newEvent()
                        .eventName(eventName)
                        .eventAction(eventObj.eventAction)
                        .target(eventObj.target)
                        .effect(eventObj.milestone)
                        .primaryCategoryIsEngagement()
                        .videoLength(eventObj.duration)
                        .build(),
                    pMappedObj
                );
            }
        });

        return function($videoContainer) {
            $videoContainer.ds2TrackingVideoContainer(tracking.getOptions('ds2-video-container'));
        }
    }
);

/**
 * @author Patrick Rathke
 * @description Video Player Refactoring (WIP)
 */

define(
    'ds2-video-player',
    [
        'jquery',
        'lazyload',
        'ds2-messages',
        'lodash',
        'ds2-cookie-controller',
        'ds2-tracking-video-layer',
        'ds2-tracking-video-container',
        'consentcontroller',
        'ds2-video-player-accessibility',
        's7-video-viewer',
        'ds2-resize-events'
    ],
    function ($, LazyLoad, Messages, _, CookieController, trackingVideoLayer, trackingVideoContainer, consentcontroller, DS2VideoPlayerAccessibility) {
        'use strict';

        function ds2VideoPlayer(element) {
            this.$element = $(element);
            this.accessibility = new DS2VideoPlayerAccessibility(element);
            new LazyLoad({ container: element });

            // options cache
            this.options = {
                canAutoplay: false,
                firstPlay: true,
                isAutoloop: this.$element.hasClass('ds2-video-player-auto-loop'),
                isAutoloopNotMobile: this.$element.hasClass('ds2-video-player-no-mobile'),
                lastAction: 'start',
                parentID: this.$element.parent().attr('id'),
                startAfterYouTubeIframeAPIReady: false,
                videoViewer: undefined
            };

            // elements cache
            this.$elements = {
                html: $('html'),
                body: $('body'),
                closeButton: this.$element.find('.ds2-video-player--player-close-button'),
                opener: $('.ds2-video-player--opener', this.$element),
                player: $('.ds2-video-player--player', this.$element),
                playButton: $('.ds2-video-player--play', this.$element)
            };

            // context cache (some checks not needed at the moment but possible in the future)
            this.context = {
                //container: this.$element.parents('.ds2-video-container').length > 0,
                contentPresentation: this.$element.parents('.ds2-content-presentation--keyvisual-image-container').length > 0 && this.$element.parents('.ds2-layer--content').length === 0,
                contentPresentationAutoloop: this.$element.parents('.ds2-content-presentation-auto-loop').length > 0 && this.$element.parents('.ds2-layer--content').length === 0,
                gallery: this.$element.parents('.ds2-gallery').length > 0,
                //hotspot: this.$element.parents('.ds2-hotspot').length > 0,
                //hotspotExtended: this.$element.parents('.ds2-hse-layer--keyvisual').length > 0,
                layerLink: this.$element.parents('.ds2-layer--content').length > 0,
                layerFullsize: this.$element.parents('.ds2-layer-fullsize').length > 0,
                magazineOverview: this.$element.parents('.ds2-magazine').length > 0,
                sound: this.$element.parents('.ds2-slider--sound-container').length  > 0,
                stagePresentation: this.$element.parents('.ds2-stage-presentation--keyvisual-image-container').length > 0 && this.$element.parents('.ds2-layer--content').length === 0,
                stagePresentationAutoloop: this.$element.parents('.ds2-stage-presentation-auto-loop').length > 0 && this.$element.parents('.ds2-layer--content').length === 0,
                stageTeaser: this.$element.parents('.ds2-stage-teaser').length  > 0,
                tapnhold: this.$element.parents('.ds2-tapnhold--item').length  > 0,
                topicSlider: this.$element.parents('.ds2-slider-toggle-content').length  > 0,
                showroomHighlight: this.$element.parents('.ds2-showroom-highlight').length > 0,
                mosaicGallery: this.$element.parents('.ds2-showroom-mosaicgallery-vertical').length  > 0 || this.$element.parents('.ds2-showroom-mosaicgallery-horizontal').length  > 0
            };


            // tracking cache
            this.trackingTimer = {
                timer: null,
                remaining: 0,
                pastMilestones: []
            };
            this.relativeTrackingTimer = {
                timer: null,
                remaining: 0,
                pastMilestones: []
            };

            // init tracking loaded via require below
            trackingVideoLayer(this.$element.closest('.ds2-lightbox--video'));
            trackingVideoContainer(this.$element.closest('.ds2-video-container'));

            this._create();
        }



        var proto = ds2VideoPlayer.prototype;

        proto._create = function () {
            var self = this;

            // add this player to global player array
            window.ds2.cl.ds2Videoplayer.push(this);

            // if video layer save the layer ID
            if (this.context.layerLink) {
                this.options.openedInLayerId = this.$element.parents('.ds2-lightbox').attr('data-lightbox-id');

                var lightbox = self.$element.closest('.ds2-lightbox')[0];
                if (lightbox) {
                    if (lightbox.getAttribute('data-component-initialized') === 'true') {
                        self.addLightboxEvents(lightbox);
                    }
                    else {
                        var config = { attributes: true, childList: false, subtree: false };
                        var callback = function(mutationsList) {
                            for(var i in mutationsList) {
                                if (mutationsList[i].attributeName === "data-component-initialized") {
                                    self.addLightboxEvents(lightbox);
                                    this.disconnect();
                                }
                            }
                        };
                        var observer = new MutationObserver(callback);
                        observer.observe(lightbox, config);
                    }
                }
            }
            else if (this.context.layerFullsize) {
                this.options.openedInLayerId = Math.random().toString(36).substring(2,15) + Math.random().toString(36).substring(2,15);
                this.$element.parents('.ds2-layer-fullsize__item').attr('data-video-layer-id', this.options.openedInLayerId);
            }
            else {
                if (epaas && epaas.api) {
                    epaas.api.registerOnUserConsentChange(function () {
                        if (epaas.api.isRegulationAccepted() && self.options.lastAction === 'fallbackOpen') {
                            self._privacyCheck();
                        }
                        if (epaas.api.isRegulationAccepted() && self.options.isAutoloop && self.$element.hasClass('ds2-video-player-auto-loop-fallback')) {
                            self._autoloop();
                        }
                    });
               }
            }

            // change videosources depending on media query for some components
            if(this.context.stagePresentation || this.context.contentPresentation || this.context.topicSlider) {
                $(window.digitals2.resizeEvents).on('ds2ResizeSmall ds2ResizeMedium ds2ResizeLarge', function (event) {
                    self._assetChangeOnResize();
                });
            }

            // @TODO check if stopAllVideos works and why it is done differently for sound component
            self.$element.closest('.ds2-component').on('stopAllVideos', function () {
                self._videoInlineClose();
                self.videoYoutubeClose();
            });

            if (epaas && epaas.api) {
                epaas.api.addEventListener('consentcontroller.api.initialized', function (event) {
                    self._afterCookieControllerInitialized();
                });
            }

            // if stagePresentationAutoloop or contentPresentationAutoloop is loaded check for autoplay
            if(((this.context.stagePresentationAutoloop || this.context.contentPresentationAutoloop || (this.context.mosaicGallery && this.options.isAutoloop)) && !this.options.canAutoplay)){
                $(window).on('ds2-video-player-checkAutoplay', function(event, parent) {
                    if ($(parent).find(self.$element).length &&  !self.options.canAutoplay) {
                        self._checkAutoplay();
                    }
                });
            }
            // if Magazine Hero-Teaser or Article Teaser XL try AutoPlay directly after init
            // for Tap and Hold Component check and wait for tap/hover
            else if((this.context.magazineOverview || this.context.tapnhold) && !this.options.canAutoplay){
                self._checkAutoplay();
            }

            // in case we have the video as scene7 under stage presentation we need to set
            // overflow unset to fix a chrome bug
            if (this.$element.parents('#stage__stagepresentation__buttonsParsys__videolink').length > 0) {
                if (this.$element.find('.ds2-video-player--sceneseven').length > 0){
                    let layerContent = this.$element.closest('.ds2-layer--content')[0];
                    if (layerContent) {
                        layerContent.style.overflow = 'unset';
                    }
                }
            }
        };



        /**
         * Autoloop videos with Autoplay
         */

        proto._checkAutoplay = function() {
            //@TODO: move to seperate js or update modernizer to use that test

            var self = this,
                delay = 250,
                testVideo = document.createElement('video');

            if(self.$elements.html.hasClass('video-autoplay')){
                self.options.canAutoplay = true;
                self._autoloop();
            }
            else {
                //create mp4 testsource, 5s long
                var mp4 = document.createElement('source');
                mp4.src = "data:video/mp4;base64,AAAAFGZ0eXBNU05WAAACAE1TTlYAAAOUbW9vdgAAAGxtdmhkAAAAAM9ghv7PYIb+AAACWAAACu8AAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAnh0cmFrAAAAXHRraGQAAAAHz2CG/s9ghv4AAAABAAAAAAAACu8AAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAFAAAAA4AAAAAAHgbWRpYQAAACBtZGhkAAAAAM9ghv7PYIb+AAALuAAANq8AAAAAAAAAIWhkbHIAAAAAbWhscnZpZGVBVlMgAAAAAAABAB4AAAABl21pbmYAAAAUdm1oZAAAAAAAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAVdzdGJsAAAAp3N0c2QAAAAAAAAAAQAAAJdhdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAFAAOABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAAEmNvbHJuY2xjAAEAAQABAAAAL2F2Y0MBTUAz/+EAGGdNQDOadCk/LgIgAAADACAAAAMA0eMGVAEABGjuPIAAAAAYc3R0cwAAAAAAAAABAAAADgAAA+gAAAAUc3RzcwAAAAAAAAABAAAAAQAAABxzdHNjAAAAAAAAAAEAAAABAAAADgAAAAEAAABMc3RzegAAAAAAAAAAAAAADgAAAE8AAAAOAAAADQAAAA0AAAANAAAADQAAAA0AAAANAAAADQAAAA0AAAANAAAADQAAAA4AAAAOAAAAFHN0Y28AAAAAAAAAAQAAA7AAAAA0dXVpZFVTTVQh0k/Ou4hpXPrJx0AAAAAcTVREVAABABIAAAAKVcQAAAAAAAEAAAAAAAAAqHV1aWRVU01UIdJPzruIaVz6ycdAAAAAkE1URFQABAAMAAAAC1XEAAACHAAeAAAABBXHAAEAQQBWAFMAIABNAGUAZABpAGEAAAAqAAAAASoOAAEAZABlAHQAZQBjAHQAXwBhAHUAdABvAHAAbABhAHkAAAAyAAAAA1XEAAEAMgAwADAANQBtAGUALwAwADcALwAwADYAMAA2ACAAMwA6ADUAOgAwAAABA21kYXQAAAAYZ01AM5p0KT8uAiAAAAMAIAAAAwDR4wZUAAAABGjuPIAAAAAnZYiAIAAR//eBLT+oL1eA2Nlb/edvwWZflzEVLlhlXtJvSAEGRA3ZAAAACkGaAQCyJ/8AFBAAAAAJQZoCATP/AOmBAAAACUGaAwGz/wDpgAAAAAlBmgQCM/8A6YEAAAAJQZoFArP/AOmBAAAACUGaBgMz/wDpgQAAAAlBmgcDs/8A6YEAAAAJQZoIBDP/AOmAAAAACUGaCQSz/wDpgAAAAAlBmgoFM/8A6YEAAAAJQZoLBbP/AOmAAAAACkGaDAYyJ/8AFBAAAAAKQZoNBrIv/4cMeQ==";
                testVideo.appendChild(mp4);

                testVideo.id = 'testAutoplayVideo' + Math.floor(Math.random() * 899999 + 100000);
                testVideo.setAttribute('autoplay','autoplay');
                testVideo.setAttribute('muted','muted');
                testVideo.setAttribute('playsinline','true');
                testVideo.setAttribute('webkit-playsinline','true');
                testVideo.setAttribute('preload', 'none');
                // video needs to be "visible" for mobile devices in order to autoplay
                testVideo.style.position = 'fixed';
                testVideo.style.top = 0;
                testVideo.style.left = 0;
                testVideo.style.height = '1px';
                testVideo.style.width = '100%';

                document.body.appendChild(testVideo);

                //test after delay if video can be autoplayed
                setTimeout(function() {
                    var playPromise = testVideo.play(),
                        videoPlay = "play" in testVideo && playPromise;

                    if (playPromise !== undefined) {
                        playPromise.then(function() {},function () {
                            // prevent console outputs like:
                            // Uncaught (in promise) DOMException: play() failed because the user didn't interact with the document first.
                        });
                    }

                    self.options.canAutoplay = !testVideo.paused || "Promise" in window && videoPlay instanceof Promise;
                    self._autoloop();
                    document.body.removeChild(testVideo);
                }, delay);
            }
        };

        proto._autoloop = function () {

            if(this.options.isAutoloopNotMobile && window.digitals2.resizeEvents.mediaQuery === 'ds2ResizeSmall'){
                //@TODO possibly add check for mobile horizontal view which is actual tablet breakpoint
                this.options.canAutoplay = false;
            }

            if(this.options.canAutoplay === true
                && epaas.api.isBrowserPersistenceEnabled(epaas.api.ENUM_PERSISTENCE_TYPE.COOKIE)
                && epaas.api.isRegulationAccepted() === true) {
                this._videoInlineOpen();
                this.$element.removeClass('ds2-video-player-auto-loop-fallback');
                this.$elements.html.addClass('video-autoplay');
            }
            else {
                this.$element.addClass('ds2-video-player-auto-loop-fallback');
            }
        };



        /**
         * Cookie Controller & Privacy
         */
        proto._privacyCheck = function () {
            var self = this;
            let  contentPresentationKeyVisual = undefined;
            let  contentPresentationKey = undefined;
            var videoElement = $('.ds2-video-player--sceneseven', this.$element);
            var image = this.$elements.opener.find('img')[0];
            var playButton = this.$elements.playButton[0];
            if (videoElement.attr('id').indexOf('youtube') > -1) {
                if (epaas && epaas.api) {
                    function consentRejectedCallback() {
                        handleFallbackPage();
                    }

                    let fallbackPageOptions = {
                        processingId: 'YouTubePlayer',
                        consentRejectedCallback: consentRejectedCallback,
                        smallPhone:false
                    };

                    function handleFallbackPage() {
                        self._videoInlineClose();
                        self.videoYoutubeClose();
                        var wraperIfExist =   self.$element.find(".wraperFallBack");
                        if(wraperIfExist[0] !==  undefined){
                            self.$element[0].removeChild(wraperIfExist[0]);
                        }
                        let wraper = document.createElement("div");
                         wraper.className="wraperFallBack";
                        let fallbackPageContainer = document.createElement("div");
                        wraper.appendChild(fallbackPageContainer);

                        if (self.context.gallery || self.context.stageTeaser) {
                            var currentSlider = document.getElementsByClassName("ds2-slider--slide columns slick-slide slick-current slick-active slick-center")[0];
                            var divHeight = currentSlider.clientHeight;
                            wraper.setAttribute("style", "height:" + divHeight + "px; margin-right: -1px;");
                            var widthWraperForSlider = parseInt(divHeight)+32;
                            fallbackPageContainer.setAttribute("style", "height:" + widthWraperForSlider + "px;");
                        }

                        if(self.context.contentPresentation || self.context.topicSlider) {
                            contentPresentationKey= self.$element[0].parentElement.parentElement.querySelector('.ds2-content-presentation--keyvisual-cta');
                            contentPresentationKeyVisual =contentPresentationKey.querySelector('.ds2-content-presentation--keyvisual-cta-container');
                            contentPresentationKey.style.position="relative";
                            contentPresentationKeyVisual.style.display="none";
                        }

                        if(divHeight < 180){
                            fallbackPageOptions.smallPhone=true;
                            fallbackPageContainer.setAttribute("style", "height:" + divHeight + "px;");
                        }
                        if(image !== undefined) {
                            image.style.display = "none";
                        }
                        if(playButton !== undefined) {
                            playButton.style.display = "none";
                        }
                        self.$element[0].appendChild(wraper);
                        if (self.options.lastAction !== 'invokeFromLayer') {
                            self.options.lastAction = 'fallbackOpen';
                        }
                        epaas.api.fallbackpage.then(bundle => bundle.handleFallbackPage(fallbackPageContainer, null, fallbackPageOptions))
                            .then(() => {
                                if(image !== undefined) {
                                    image.style.display = "block";
                                }
                                if(playButton !== undefined) {
                                    playButton.style.display = "block";
                                }
                                var wraperIfExist =   self.$element.find(".wraperFallBack");
                                if(wraperIfExist[0] !==  undefined) {
                                    self.$element[0].removeChild(wraperIfExist[0]);
                                }
                                if(contentPresentationKeyVisual !== undefined){
                                    contentPresentationKeyVisual.style.display = "block";
                                    contentPresentationKey.style.position="absolute";
                                }
                                if (!self.options.openedInLayerId || self.options.lastAction === 'videoLayerOpen' || self.options.lastAction === 'invokeFromLayer') {
                                    self._videoInlineOpen();
                                } else {
                                    self._videoLayerOpen();
                                }
                            })
                            .catch((error) => {
                                console.error('Fallback page promise rejected:', error.message);
                            });

                    }

                    handleFallbackPage();
                }
            } else {
                if (!self.options.openedInLayerId || self.options.lastAction === 'videoLayerOpen' || self.options.lastAction === 'invokeFromLayer') {
                    self._videoInlineOpen();
                } else {
                    self._videoLayerOpen();
                }
            }
        };


        proto._afterCookieControllerInitialized = function () {
            var self = this;

            var playVideo = function (target) {
                self.options.lastAction = 'videoLayerOpen';
                self._privacyCheck();
                // let the slider know the video starts playing, sound player stops all other videos playing in sound component
                $(target).closest('.ds2-slider').trigger('playVideoStart').trigger('autoPlayDisable');
            };

            // inside the sound player the play button is optional --> check for play button
            if (this.$elements.playButton.length > 0) {
                this.$elements.playButton.on('click', function (e) {
                    playVideo(this);
                });
            } else if (this.context.sound) {
                // play video in sound player
                $('.ds2-video-player--img-outer', this.$element).on('click', function () {
                    playVideo(this);
                });
            }
        };

        /**
         * Layer
         */

        proto.invokeFromLayer = function () {
            var self = this;

            this.options.lastAction = 'invokeFromLayer';

            if(self.options.isAutoloop) {
                self._hideOpener();
                self._checkAutoplay();
            }
            else {
                this._privacyCheck();
                setTimeout(function() {
                    self._videoPlayerResize();
                }, 250);
            }
        };

        proto.setBackFromLayer = function () {
            this.options.lastAction = 'start';
        };

        proto._videoLayerOpen = function () {
            var self = this;
            setTimeout(function () {
                self.invokeFromLayer();
            }, 500);
        };



        /**
         * Player size calculation
         */

        proto._videoPlayerRatio = function () {
            var videoOpener = this.$elements.opener.find('img'),
                dataMobile,
                dataDesktop;

            // if video is in extra container search for opener img/ratios in slider
            if(this.context.gallery || this.context.stageTeaser){
                videoOpener = $('.ds2-slider--video-player-opener[data-id="' + this.options.parentID + '"]').find('img');
            }

            dataMobile = videoOpener.data('mobile-aspect-ratio');
            dataDesktop = videoOpener.data('desktop-aspect-ratio');

            this.options.ratioDesktop = dataDesktop ? dataDesktop : (videoOpener.width()/videoOpener.height());
            this.options.ratioMobile = dataMobile ? dataMobile : this.options.ratioDesktop;

            this.options.ratioDesktopMin = (this.context.stagePresentation || this.context.stageTeaser || this.context.topicSlider || this.context.sound || this.context.magazineOverview) ? 20/9 : 16/9;
            this.options.ratioMobileMin = ((this.context.stagePresentation && !this.context.stagePresentationAutoloop) || (this.context.contentPresentation && !this.context.contentPresentationAutoloop) || this.context.tapnhold) ? 3/4 : this.options.ratioDesktopMin;
        };

        proto._videoPlayerResize = function () {
            var videoPlayer = this.$elements.player,
                videoOpener = this.$elements.opener,
                videoOpenerImage = this.$elements.opener.find('img'),
                videoOpenerWidth,
                widthPercent,
                openerRatio = this.options.ratioDesktop,
                playerMinRatio = this.options.ratioDesktopMin;

            if (window.digitals2.resizeEvents.mediaQuery === 'ds2ResizeSmall') {
                openerRatio = this.options.ratioMobile;
                playerMinRatio = this.options.ratioMobileMin;
            }

            if (!(this.videoViewer && this.videoViewer.container && this.videoViewer.container.isFullScreen())) {
                var videoOpenerState = this.$elements.opener.hasClass('hide');

                this.$elements.opener.toggleClass('hide', false);
                videoOpenerWidth = (videoOpenerImage.length > 0) ? videoOpenerImage.width() : videoOpener.width();
                widthPercent = (videoOpenerWidth / window.innerWidth) * 100;
                this.$elements.opener.toggleClass('hide', videoOpenerState);

                // final
                if (openerRatio < playerMinRatio) {
                    if (window.innerWidth * widthPercent / 100 / openerRatio < window.innerHeight) {
                        videoPlayer.css({'height': widthPercent / openerRatio + 'vw'});
                    } else {
                        videoPlayer.css({'height': window.innerHeight + 'px'});
                    }
                }
                else {
                    if (window.innerWidth * widthPercent / 100 / playerMinRatio < window.innerHeight) {
                        videoPlayer.css({'height': widthPercent / playerMinRatio + 'vw'});
                    } else {
                        videoPlayer.css({'height': window.innerHeight + 'px'});
                    }
                }
            } else {
                videoPlayer.css({'height': window.innerHeight + 'px'});
            }
            var self = this;
            // tmp fix a chrome bug for stage presentation when video runs on page
            let keyVisualImageContainer = this.$element.closest('.ds2-stage-presentation--keyvisual-image-container')[0];
            if (keyVisualImageContainer) {
                if (this.$element.find('.ds2-video-player--sceneseven').length > 0){
                    setTimeout(function() {
                        self.$element[0].style.overflow = 'auto';
                        setTimeout(function() {
                            self.$element[0].style.overflow = 'unset';
                        }, 50);
                    }, 200);
                }
            }
        };

        proto._videoPlayerFullscreenPosition = function () {
            var isFullScreen = this.videoViewer.container.isFullScreen(),
                fullScreenPlayer = $(".s7innercontainer[mode='fullscreen']", this.$element);

            // toggle css class on body for overflow and z-index fixes
            this.$elements.body.toggleClass('ds2-video-player--isFullscreen', isFullScreen);
            var scrollTop = $(window).scrollTop();
            var offsetTop = this.$element.offset().top;
            var scrollLeft = $(window).scrollLeft();
            var offsetLeft = this.$element.offset().left;


            // correct s7 top position if in 'fake fullscreen mode' (full browser window) including iPad
            if (isFullScreen === true
                && fullScreenPlayer
                && this._isIos() ){
                fullScreenPlayer.css({top: (scrollTop - offsetTop), left: (scrollLeft - offsetLeft)});
            }

            this._videoPlayerResize();
        };



        /**
         * generic for scene7 & youtube
         */

        proto.videoInitComplete = function () {
            var self = this,
                video = this.$element.find('video'),
                source = video.find('source'),
                videoDuration;

            self.videoViewer.container = self.videoViewer.container || {};
            self.videoViewer.container.addEventListener(s7sdk.event.AssetEvent.ASSET_CHANGED, function (event) {
                self.currentAssetPath = event.s7event.asset.name;

            }, true);

            this.videoViewer.container.addEventListener(s7sdk.event.StatusEvent.NOTF_VIEW_READY, function (pEvent) {
                self.$elements.opener.toggleClass('hide', true);

                if (!self.context.mosaicGallery && !self.context.tapnhold && !self.context.contentPresentation && !self.context.showroomHighlight) {
                    $(window).trigger('ds2-video-player-open');
                }
            }, true);

            this.videoViewer.container.addEventListener(s7sdk.event.ResizeEvent.FULLSCREEN_RESIZE, function (pEvent) {
                var pId = $(this).closest('.ds2-slider--video-single').attr('id');
                if (self.videoViewer.container.isFullScreen()) {
                    self._videoFullScreenModeTrigger(true, pId);
                } else {
                    $('.s7container', self.$element).attr('mode', 'normal');
                    self._videoFullScreenModeTrigger(false, pId);
                }
                self._videoPlayerFullscreenPosition();
            });

            // temp fix for BMWDGTLTP-2255 // video can't be played on ios 10
            if(this._isIosVersion() === 10){
                var oldsrc = source.attr('src'),
                    newsrc = oldsrc.replace('-AVS.m3u8', '').replace('.m3u8', '');

                if(newsrc !== oldsrc){
                    source.attr('src', newsrc);
                }
            }

            // additional attributes & styles for scene7 video
            video.attr('playsinline','true').attr('webkit-playsinline','true').css({'width':'100%','height':'100%','top':'0','left':'0'});

            // mute autolooping / autoplaying video
            if(this.options.isAutoloop && this.options.canAutoplay){
                self._hideOpener();
                video.attr('muted','muted').attr('preload','none');
                video[0].volume = 0;
                video[0].muted = true;
                if(!this.context.tapnhold){
                    video.attr('autoplay','autoplay');
                    video[0].autoplay = true;
                    video[0].load();
                    video[0].play();
                    videoDuration = self.videoViewer.videoTime.component.duration / 1000;
                    self.trackStart(self, null, null, videoDuration, null, true);
                }
            }

            // start video if not autoplay
            if(!self.options.canAutoplay && !self.options.isAutoloop){
                self._hideOpener();
                if (self._isIos()) {
                   setTimeout(function() {
                      self.videoViewer.videoplayer.play();
                    }, 100);
                } else {
                    self.videoViewer.videoplayer.play();
                }

                videoDuration = self.videoViewer.videoTime.component.duration / 1000;
                self.trackStart(self, null, null, videoDuration, null, true);
            }
        };

        proto._videoInlineOpen = function () {
            var self = this,
                videoContainer = this.$element.parents('.ds2-slider--video-container').first(),
                element = $('.ds2-video-player--sceneseven', this.$element),
                video = element.find('video');

            // save player min ratio and opener ratio to options
            self._videoPlayerRatio();
            self._videoPlayerResize();
            //self._videoPlayerFullscreenPosition();

            $(window.digitals2.resizeEvents).on('ds2ResizeSmall ds2ResizeMedium ds2ResizeLarge', self, _.throttle(function (e) {
                self._videoPlayerResize();
                self._videoPlayerFullscreenPosition();
            }, 250));

            // player needs to be visible in order to load a video - display:none does not work,
            // but it needs to be visually hidden until the video has loaded
            if(this.$elements.player.find('[autoplay]').length === 0){
                this.$elements.player.toggleClass('hide', false);
                this.$elements.player.toggleClass('visually-hidden', true);
                if (!this.context.tapnhold
                    && !this.context.contentPresentationAutoloop
                    && !this.context.stagePresentationAutoloop
                    && !this.context.stageTeaser) {
                    this.accessibility.focusPlayer();
                }
            }

            if (element.length !== 0) {
                if (element.attr('id').indexOf('youtube') > -1) {
                    this._videoplayerStartYoutubeApi(element);
                }
                else if (video.length) {
                    if (video[0].hasAttribute('autoplay')) {
                        video[0].play();
                    }
                    else {
                        this._videoplayerStartSDKVersion(element);
                    }
                }
                else {
                    this._videoplayerStartSDKVersion(element);
                }

                if (self.options.openedInLayerId) {
                    $(document).on('close.fndtn.reveal', '[data-reveal]', function () {
                        self._videoInlineClose();
                        self.videoYoutubeClose();
                    });
                }
            }

            // @TODO check stageteaser
            if (this.context.stageTeaser && videoContainer && videoContainer.find('button').length === 0) {
                this.$element.parents('.ds2-stage-teaser').first().find('.ds2-slider--main button')
                    .clone(true, true)
                    .appendTo(videoContainer);

                videoContainer.hover(function () {
                    $('.slick-prev, .slick-next', this).css('opacity', 1);
                }, function () {
                    $('.slick-prev, .slick-next', this).css('opacity', 0);
                });
            }

            var classesAsParents = [
                '.ds2-stage-presentation',
                '.ds2-stage-teaser',
            ];

            // When we use new navigation and we are on page with stage teaser hide close button
            if (window.uxn && window.uxn.enabled && self.$elements.player.parents(classesAsParents.join(',')).length) {
                this._closeButtonDisable();
            } else {
                this._closeButtonEnable();
                if(this.context.contentPresentation) {
                    this.accessibility.addKeyboardSupport();
                }
            }
        };

        proto._videoInlineClose = function () {
            this.firstPlay = true;
            if (this.videoViewer && this.videoViewer.videoplayer) {
                this.videoViewer.videoplayer.stop();
            }
            this.$elements.player.toggleClass('hide', true);
            this.$elements.opener.toggleClass('hide', false);

            if (this.context.stageTeaser || this.context.stagePresentation || this.context.contentPresentation || this.context.topicSlider) {
                this.$element.closest('.ds2-slider').trigger('videoOverlayClose');
            }

            if (this.videoViewer && this.videoViewer.container && this.videoViewer.container.cancelFullScreen) {
                // cancel full screen for iphone, when closing the layer, otherwise the touch (scroll) events remain disabled
                // BMWWEB-21122 - UXS - scrolling is not possible after closing the highlight video
                this.videoViewer.container.cancelFullScreen();
            }
            this._closeButtonDisable();
            var bodyEl = this.$elements.body;
            bodyEl.hasClass('ds2-video-player--isFullscreen') && bodyEl.removeClass('ds2-video-player--isFullscreen');
            if (this.context.contentPresentation) {
                this.accessibility.focusPlayButton();
            }
        };



        /**
         * scene7
         */

        proto._videoplayerStartSDKVersion = function (element) {
            var self = this,
                $sceneseven = element,
                id = $sceneseven.attr('id'),
                domain = $sceneseven.data('video-domain'),
                path = $sceneseven.data('video-path'),
                caption = $sceneseven.data('subtitle-url'),
                assetPath = self._getResponsiveUrl(),
                preset = $sceneseven.data('video-preset');

            if (self.videoViewer && self.videoViewer.videoplayer) {
                if(!self.options.canAutoplay){
                    self._hideOpener();
                    self.videoViewer.videoplayer.play();
                    var videoDuration = self.videoViewer.videoTime.component.duration / 1000;
                    self.trackStart(self, null, null, videoDuration);
                }
                self._closeButtonEnable();
            }
            else {
                $sceneseven.css({'opacity': '0'});
                if (window.s7viewers !== undefined && path !== undefined) {

                    var defaultParams = {
                        'autoplay': '0',
                        'playback': 'auto',//native,auto
                        'asset': assetPath,
                        'serverurl': domain + 'is/image/',
                        'contenturl': domain + 'skins/',
                        'config': 'Scene7SharedAssets/Universal_HTML5_Video',
                        'videoserverurl': domain + 'is/content/'
                    };

                    if (self.options.isAutoloop && self.options.canAutoplay) {
                        if(!self.context.tapnhold) defaultParams.autoplay = '1';
                        if(!self.context.tapnhold) defaultParams.loop = '1';
                        defaultParams.muted = '1';
                        defaultParams.iconeffect = '0';
                        defaultParams.singleclick = 'none';
                        defaultParams.doubleclick = 'none';
                    }

                    if (caption && caption.length > 0) {
                        defaultParams['caption'] = caption;
                    }

                    self.videoViewer = new s7viewers.VideoViewer({
                        'containerId': id,
                        'params': defaultParams,
                        'handlers': {
                            'initComplete': function () {
                                self.currentAssetPath = assetPath;
                                self.videoInitComplete();
                                $sceneseven.css({'opacity': ''});

                                if(self.videoViewer.isCaption)
                                {
                                    self.videoViewer.closedCaptionButton.setSelected(true);
                                    self.videoViewer.videoplayer.setCaptionEnabled(true);
                                }
                            },
                            'onFullScreenEnter': function (e) {
                                self.videoInitComplete();
                                $sceneseven.css({'opacity': ''});
                            },
                            'trackEvent': function (objID, compClass, instName, timeStamp, eventInfo) {
                                console.log('trackEvent --> eventInfo: ', eventInfo);

                                //var eventInfoValue = eventInfo.split(',')[0];

                                if (eventInfo.split(',')[0] === 'PLAY' && self.firstPlay === true) {

                                    var id, effect;

                                    id = $(self.$element).closest('.ds2-slider--video-single').attr('id');
                                    if (id) {
                                        effect = $("div[data-id='" + id + "']").closest('.ds2-slider--slide.slick-active').find('.ds2-stage-slider--keyvisual-cta-location').find('h1').text();
                                    }
                                } else if (eventInfo.split(',')[0] === 'MILESTONE' &&
                                    eventInfo.split(',')[1] === '100' && self.context.stageTeaser) {
                                    self._videoInlineClose();
                                }
                            }
                        },
                        'localizedTexts': {
                            'en': {
                                'VideoPlayer.ERROR': 'Your Browser does not support HTML5 Video tag or the video cannot be played.'
                            },
                            'fr': {
                                'VideoPlayer.ERROR': 'Votre navigateur ne prend pas en charge la vidéo HTML5 tag ou la vidéo ne peuvent pas être lus.'
                            },
                            defaultLocale: 'en'
                        }
                    }).init();
                }
            }
        };

        proto._hideOpener = function() {
            this.$elements.opener.toggleClass('hide', true);
            this.$elements.player.toggleClass('hide', false);
            this.$elements.player.toggleClass('visually-hidden', false);

            this.$element.closest('.ds2-slider--video-container').show();
            this.$element.closest('.ds2-slider--video-single').show();
        };


        /**
         * youtube
         */

        proto._videoplayerStartYoutubeApi = function (element) {
            var self = this;

            this.startAfterYouTubeIframeAPIReady = true;
            if (window.digitals2.youTubeIframeAPIReady === true) {
                this.videoplayerStartYoutubeVideo();
            }
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                $(window).on('youTubeIframeAPIReady', function() {
                    self.videoplayerStartYoutubeVideo();
                });
            }
        };

        proto.videoplayerStartYoutubeVideo = function () {
            if (this.startAfterYouTubeIframeAPIReady === false || !$('iframe.ds2-video-player--sceneseven', this.$element)) {
                return;
            }
            if ($('iframe.ds2-video-player--sceneseven', this.$element) && this.playerYoutube && typeof this.playerYoutube.playVideo === "function") {
                this._hideOpener();
                this.playerYoutube.playVideo();
                return;
            }

            // hide opener / preview image when video is ready
            this._hideOpener();

            var self = this;
            var $embedContainer = $('.ds2-video-player--sceneseven', this.$element).find('.ds2-youtube-embed-container');
            var videoPath = $('.ds2-video-player--sceneseven', this.$element).attr('video-path');

            this.playerYoutube = new YT.Player($embedContainer[0], {
                videoId: videoPath,
                width: '100%',
                height: '100%',
                playerVars: {
                    'modestbranding': 0,
                    'controls': 1,
                    'autohide': 1,
                    'rel': 0,
                    'showinfo': 0,
                    'playsinline': 1,
                    'iv_load_policy': 3,
                    'fs': 1
                },
                events: {
                    'onReady': function (event) {
                        event.target.playVideo();
                    },
                    'onStateChange': function (event) {
                        self.onPlayerStateChange(event, self);
                    }
                }
            });
        };

        proto.onPlayerStateChange = function (event, scope) {
            function getCurrentTime() {
                if (typeof scope.playerYoutube.getCurrentTime === "function") {
                    return Math.round(scope.playerYoutube.getCurrentTime());
                }
                else {
                  return null
                }
            }

            function getCurrentPercent() {
                if (typeof scope.playerYoutube.getCurrentTime === "function" && typeof scope.playerYoutube.getDuration === "function") {
                    return Math.round(scope.playerYoutube.getCurrentTime() / scope.playerYoutube.getDuration() * 100);
                }
            }

            function getDuration() {
                if (typeof scope.playerYoutube.getDuration === "function") {
                    return Math.round(scope.playerYoutube.getDuration());
                }
            }

            /**
             * test if we have reached a milestone and call tracking event
             */
            function intervalCallback() {
                var currentTime = getCurrentTime();

                // track absolute progress
                if (currentTime === 10) scope.trackProgress('abs', currentTime, scope);
                if ((currentTime % 30) === 0) scope.trackProgress('abs', currentTime, scope);
            }

            function relativeIntervalCallback() {
                var currentPercent = getCurrentPercent();

                // track relative progress
                if (currentPercent === 10) scope.trackProgress('rel', currentPercent, scope);
                if (currentPercent === 25) scope.trackProgress('rel', currentPercent, scope);
                if (currentPercent === 50) scope.trackProgress('rel', currentPercent, scope);
                if (currentPercent === 75) scope.trackProgress('rel', currentPercent, scope);
                if (currentPercent === 95) scope.trackProgress('rel', currentPercent, scope);
            }

            /**
             * receive YouTube player state
             */
            switch (event.data) {
                case YT.PlayerState.PLAYING:
                    (function () {
                        var interval = 100;
                        // video started
                        if (getCurrentTime() === 0) {
                            if (scope.firstPlay === true &&
                                (scope.lastAction === 'videoLayerOpen' || scope.lastAction === 'invokeFromLayer')) {
                                scope.trackStart(
                                    scope,
                                    '',
                                    scope.playerYoutube.getVideoUrl(),
                                    getDuration(),
                                    scope.$element.data('tracking-options').name
                                );
                            }
                            scope.trackProgress('abs', 0, scope);
                            scope.trackProgress('rel', 0, scope);
                            scope.trackingTimer.timer = setInterval(intervalCallback, interval);
                            scope.relativeTrackingTimer.timer = setInterval(relativeIntervalCallback, interval);
                        } else {
                            // video resumed
                            intervalCallback();
                            relativeIntervalCallback();
                            scope.trackingTimer.timer = setInterval(intervalCallback, interval);
                            scope.relativeTrackingTimer.timer = setInterval(relativeIntervalCallback, interval);
                        }
                    })();
                    break;

                case YT.PlayerState.PAUSED:
                case YT.PlayerState.BUFFERING:
                    clearInterval(scope.trackingTimer.timer);
                    clearInterval(scope.relativeTrackingTimer.timer);
                    break;

                case YT.PlayerState.ENDED:
                    clearInterval(scope.trackingTimer.timer);
                    clearInterval(scope.relativeTrackingTimer.timer);

                    scope.videoYoutubeClose();
                    break;
            }
        };

        proto.videoYoutubeClose = function () {
            this._videoInlineClose();
            if (this.playerYoutube) {
                var $video = $('.ds2-video-player--sceneseven', this.$element);
                var id = $video.find('.ds2-youtube-embed-container').attr('id');

                if (typeof this.playerYoutube.stopVideo === "function") {
                    this.playerYoutube.stopVideo(-1);
                }
                if (typeof this.playerYoutube.seekTo === "function") {
                    this.playerYoutube.seekTo(0);
                }
                if (typeof this.playerYoutube.destroy === "function") {
                    this.playerYoutube.destroy();
                }

                clearInterval(this.trackingTimer.timer);
                clearInterval(this.relativeTrackingTimer.timer);

                $video.find('.ds2-youtube-embed-container').remove();
                $video.html('<div id="' + id + '" class="ds2-youtube-embed-container"></div>');

                if (this.context.stageTeaser || this.context.stagePresentation || this.context.contentPresentation || this.context.topicSlider) {
                    this.$element.closest('.ds2-slider').trigger('videoOverlayClose');
                }

                this.playerYoutube = undefined;
            }
        };



        /**
         * buttons & interaction elements
         */

        proto._closeButtonEnable = function () {
            var self = this;

            if (this.context.stageTeaser || this.context.stagePresentation || this.context.contentPresentation || this.context.topicSlider) {
                $('.ds2-video-player--player-close-button', this.$element)
                    .toggleClass('ds2-is-visible', true)
                    .off('click')
                    .on('click', function () {
                        self._videoInlineClose();
                        self.videoYoutubeClose();
                    });
            }
        };

        proto._closeButtonDisable = function () {
            $('.ds2-video-player--player-close-button', this.$element)
                .toggleClass('ds2-is-visible', false)
                .off('click');
        };

        proto._videoFullScreenModeTrigger = function (pValue, pId) {
            this.$element.closest('.ds2-slider').trigger('fullscreenModeInPlayerIsActive', [pValue, pId]);
        };



        /**
         * change videosource for portrait videos on mobile
         */

        proto._getResponsiveUrl = function () {
            var self = this,
                mediaQuery = window.digitals2.resizeEvents.mediaQueryWatcherCheck(),
                desktopInfos = $('.ds2-video-player--sceneseven', this.$element),
                mobileInfos = $('.ds2-video-player--mobile', this.$element);

            //@TODO what about youtube? (editor can set up two youtube links)

            if (desktopInfos && desktopInfos.attr('id') && desktopInfos.attr('id').indexOf('youtube') > -1) {
                return;
            } else if (mobileInfos.length === 0) {
                return desktopInfos.data('video-asset-path');
            }

            if (mediaQuery === 'ds2ResizeSmall') {
                return mobileInfos.data('video-asset-path');
            } else {
                return desktopInfos.data('video-asset-path');
            }

        };

        proto._assetChangeOnResize = function () {
            var self = this;
            var assetPath = self._getResponsiveUrl();

            //@TODO what about youtube? (editor can set up two youtube links)

            if (typeof self.videoViewer !== 'undefined') {
                if (assetPath !== self.currentAssetPath) {
                    if(!this.context.stagePresentationAutoloop && !this.context.contentPresentationAutoloop){
                        self._videoInlineClose();
                    }
                    self.videoViewer.setAsset(assetPath);
                }
            }
        };

        proto.addLightboxEvents = function(lightbox) {
            var self = this;

            lightbox.addEventListener(lightbox.Lightbox.eventIds.open, function () {
                self._videoLayerOpen();
            });

            lightbox.addEventListener(lightbox.Lightbox.eventIds.close, function () {
                self._videoInlineClose();
                self.videoYoutubeClose();
            });
        };



        /**
         * tracking
         */

        proto.getEvent = function () {
            return {
                eventInfo: {
                    eventName: '',
                    eventAction: '',
                    eventPoints: '',
                    timeStamp: Date.now().toString(),
                    target: '',
                    cause: '',
                    effect: ''
                },
                category: {
                    primaryCategory: '',
                    mmdr: '',
                    eventType: ''

                },
                attributes: {
                    relatedPageName: '',
                    relatedPageCategory: '',
                    relatedComponent: {
                        componentInfo: '',
                        category: '',
                        attributes: ''
                    }
                }
            };
        };

        proto.trackProgress = function (mode, milestone, scope) {
            if (mode === 'abs') {
                if (scope.trackingTimer.pastMilestones.indexOf(milestone) === -1) {
                    scope.trackingTimer.pastMilestones.push(milestone);
                    this.$element.trigger('ds2-video-player-track-absolute-progress', {
                        milestone: milestone,
                        duration: Math.round(scope.playerYoutube.getDuration()),
                        target: scope.playerYoutube.getVideoUrl()
                    });
                }
            }
            else if (mode === 'rel') {
                if (scope.relativeTrackingTimer.pastMilestones.indexOf(milestone) === -1) {
                    scope.relativeTrackingTimer.pastMilestones.push(milestone);
                    this.$element.trigger('ds2-video-player-track-relative-progress', {
                        milestone: milestone + '%',
                        duration: Math.round(scope.playerYoutube.getDuration()),
                        target: scope.playerYoutube.getVideoUrl()
                    });
                }
            }
        };

        proto.trackStart = function (scope, effect, target, videoLength, eventName, autoLoop) {
            var pEvent = scope.getEvent();
            pEvent.eventInfo.effect = effect;
            pEvent.eventInfo.eventAction = 'Start video';
            pEvent.eventInfo.target = target;
            pEvent.eventInfo.cause = 'automatic';
            pEvent.category.primaryCategory = 'Engagement';
            pEvent.attributes.videoLength = videoLength;
            pEvent.eventInfo.eventName = eventName;
            if (scope.$element.closest('.ds2-lightbox--video').length) {
                scope.$element.trigger('ds2-video-player-play-layer', pEvent);
            } else {
                if (scope.$element.closest('.ds2-showroom-highlight').length || scope.$element.closest('.ds2-showroom-mosaicgallery').length) {
                    var element = scope.$element.closest('.ds2-layer-fullsize__item');
                    if (scope.$element.closest('.ds2-showroom-mosaicgallery').length) {
                        if (!element.length) {
                            element = scope.$element;
                        }
                    }
                    scope.$element.trigger('ds2-showroom-start-video-event', [element, videoLength, autoLoop]);
                } else {
                    scope.$element.trigger('ds2-video-player-play', pEvent);
                }

            }
            scope.firstPlay = false;
        };



        /**
         * helper
         */

        proto._isIos = function () {
            return (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream)
        };

        proto._isIosVersion = function () {
            var version = 0;
            if(this._isIos()){
                var ua = navigator.userAgent,
                    uaIndex = ua.indexOf( 'OS ');
                if (uaIndex > -1 ) {
                    version =  parseInt(ua.substr( uaIndex + 3, 2 ));
                }
            }

            return version;
        };



        //varibale to store initalized video players
        window.ds2 = window.ds2 || {};
        window.ds2.cl = window.ds2.cl || {};
        window.ds2.cl.ds2Videoplayer = window.ds2.cl.ds2Videoplayer || [];

        return ds2VideoPlayer;
    }
);

/**
 * This function needs to be registered globaly. youtube api
 */
function onYouTubeIframeAPIReady() {
    window.digitals2.youTubeIframeAPIReady = true;
    $(window).trigger('youTubeIframeAPIReady');
}

define(
    'ds2-video-player-accessibility',
    [
        'jquery',
        'ds2-accessibility',
    ],function($, Accessibility) {
        'use strict';

        function DS2VideoPlayerAccessibility(element) {
            this.accessibility = new Accessibility(element);
            this.$element = $(element);
            this.$elements = {
                closeButton: $('.ds2-video-player--player-close-button', this.$element),
                player: $('.ds2-video-player--player', this.$element),
                playButton: $('.ds2-video-player--play', this.$element)
            };
        }

        DS2VideoPlayerAccessibility.prototype.addKeyboardSupport = function() {
            if (!this.$element || !this.$elements.closeButton) return;
            var self = this;

            // Use ESC to close the video
            self.accessibility.addKeyListener('up', {
                element: self.$element,
                keyCodes: [self.accessibility.keyCodes.ESC],
                fn: function () {
                    self.$elements.closeButton.click();
                }
            });
        }

        DS2VideoPlayerAccessibility.prototype.focusPlayer = function () {
            this.accessibility.focusElement(this.$elements.player, true, true);
        }

        DS2VideoPlayerAccessibility.prototype.focusPlayButton = function () {
            this.accessibility.focusElement(this.$elements.playButton);
        }

        return DS2VideoPlayerAccessibility;

    });

